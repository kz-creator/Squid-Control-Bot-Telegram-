Телеграм‑бот для администрирования **Squid**: управление категориями (группами доменов), белым списком IP, политиками доступа на уровне всей сети, отделов и отдельных IP‑адресов. Бот сам вносит изменения в `squid.conf` только внутри собственного управляемого блока, проверяет синтаксис и перезагружает Squid.

> **Зачем?** Чтобы не лазить руками в `squid.conf` и файлы списков. Все операции — из Telegram через удобные кнопки и диалоги с подтверждениями.

---

## Возможности

- **Категории (группы доменов)**  
  В комплекте преднастроены:
  - «Букмекерские сайты»  
  - `WhatsApp`  
  - «Социальные сети»  
  - «Общие ограничения»  
  Каждая группа — это отдельный файл со списком доменов; можно просматривать счётчик записей, добавлять и удалять элементы, включать/выключать группы в политике.

- **Политики доступа (три уровня):**
  1) **Глобально** — по умолчанию для всех.  
  2) **По отделам** — переопределение для отдела (набор IP).  
  3) **По IP** — точечное переопределение для конкретного адреса.
  
  Доступные модели:
  - *Разрешено всё, кроме выбранных групп* (`allow_all_except`)
  - *Запрещено всё, кроме выбранных групп* (`deny_all_except`)

- **Белый список IP**  
  Файл с IP/подсетями, которым всегда разрешён доступ (проверяется первым).

- **Автогенерация блока в `squid.conf`**  
  Бот вставляет/обновляет только участок между:
Внутри — ACL и `http_access` в правильном порядке (whitelist → IP‑переопределения → отделы → глобальные правила → allow localhost/localnet → deny all).

- **Отделы и их IP**  
Для каждого отдела — собственный source‑файл с IP (ACL `src`). Можно добавлять/удалять IP из Telegram, постраничный список IP с пометкой переопределений.

- **Динамический ввод значений**  
В сценариях добавления/удаления доменов/IP бот остаётся в режиме ввода: можно отправлять по одному значению, списком (через пробел/переводы строк) и завершить словом **«готово»** или кнопкой «Отмена».

- **Статистика и отчёты**  
Парсинг `access.log`: методы, коды, топ доменов и блокировок, топ IP с отказами. Генерация красивого HTML‑отчёта (шаблон создаётся автоматически).

- **Резервное копирование и восстановление**  
Резервирует управляемые файлы и позволяет откатиться.

---

## Где что хранится (по умолчанию)

**Файлы Squid**
- Конфиг: `/etc/squid/squid.conf`
- Категории (группы):  
- `/etc/squid/deny_betting`  
- `/etc/squid/deny_whatsapp`  
- `/etc/squid/deny_social`  
- `/etc/squid/deny_common`
- Белый список IP: `/etc/squid/whitelist_ip`
- Источники отделов (IP списки): `/etc/squid/departments/<slug>.src`

**Состояние бота**
- `/var/lib/squid-bot-state/`
- `bot_config.json` — глобальная конфигурация
- `departments.json` — отделы и их IP (если в проекте используется)
- `groups.json` — переопределения свойств групп (если менялись из бота)
- `access.log.offset` — позиция «хвоста» логов

**Шаблоны и отчёты**
- Шаблоны HTML: `/var/lib/squid-bot-templates/` (создаст `sarg_report.html`, если его нет)
- Отчёты: `/var/lib/squid-bot-reports/*.html`

> Пути можно адаптировать в коде/форке; по умолчанию используются именно эти.

---

## Требования

- Linux (проверено на AlmaLinux/RHEL‑семействе)
- Python **3.9+**
- Squid установлен и работает
- Права на чтение/запись в перечисленные директории и файлы

Python‑зависимости:

Создайте `requirements.txt` (опционально):
```txt
aiogram==3.*
Jinja2==3.*
